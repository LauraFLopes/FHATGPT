<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>FH Wedel Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="app">
    <main class="main-chat">

        <!-- Header -->
        <header class="chat-header">
            <div class="header-left">
                <img src="https://lms.fh-wedel.de/pluginfile.php/1/core_admin/logo/0x200/1743342702/fh-logo.png" alt="FH Wedel Logo">
            </div>
            <div class="header-center">
                <span class="header-title">FH Wedel Chatbot</span>
            </div>
            <div class="header-right">
                <button id="new-chat-btn" class="new-chat-btn" title="Neuer Chat" aria-label="Neuer Chat">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path d="M10 4V16M4 10H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Neuer Chat
                </button>
            </div>
        </header>



        <div class="trennbalken"></div>

        <!-- Chat-Verlauf -->
        <section id="chat-box" class="chat-box">
            {% for message in chat_history %}
            <div class="message {{ message.role }}">{{ message.content.strip() }}</div>
            {% endfor %}
        </section>

        <!-- Eingabefeld -->
        <div class="input-container">
            <input id="question" placeholder="Deine Frage..." autocomplete="off" />
            <button onclick="ask()">âž¤</button>
        </div>

        <!-- Animation -->
        <div style="position:fixed; bottom:10px; left:0; z-index:9999;">
            <img src="https://i.gifer.com/XOsX.gif" style="width:70px; animation: walk 15s linear infinite;">
        </div>
        <style>
            @keyframes walk {
                0% { transform: translateX(0) scaleX(1); }
                50% { transform: translateX(25vw) scaleX(1); }
                51% { transform: translateX(25vw) scaleX(-1); }
                99% { transform: translateX(0) scaleX(-1); }
                100% { transform: translateX(0) scaleX(1); }
            }
        </style>

    </main>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("question");

    input.addEventListener("keydown", e => {
        if (e.key === "Enter") ask();
    });

    function ask() {
        const question = input.value.trim();
        if (!question) return;

        appendMessage("user", question);

        fetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question })
        })
            .then(res => res.json())
            .then(data => {
                appendMessage("bot", data.answer.trim());
            });

        input.value = "";
    }

    function appendMessage(role, content) {
        const message = document.createElement("div");
        message.className = `message ${role}`;

        const trimmed = content.trim();
        const isSingleLine = !trimmed.includes('\n');

        let markdown = trimmed.replace(/\n+$/, '').replace(/\n/g, '  \n');
        let html = isSingleLine
            ? marked.parseInline(markdown)
            : marked.parse(markdown);

        html = html.replace(/(<br\s*\/?>\s*)+$/i, '').replace(/(<p>\s*<\/p>\s*)+$/i, '');

        message.innerHTML = html;
        chatBox.appendChild(message);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Neuer Chat Button
    document.getElementById("new-chat-btn").addEventListener("click", () => {
        fetch("/reset", { method: "POST" })
            .then(() => {
                chatBox.innerHTML = "";
            });
    });
</script>
</body>
</html>